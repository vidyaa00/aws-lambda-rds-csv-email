import os
import pg8000
import csv
import io
import boto3
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from email.mime.application import MIMEApplication


def lambda_handler(event, context):

    try:
        print("Lambda triggered")

        # ---------- Environment Variables ----------
        DB_HOST = os.environ['DB_HOST']
        DB_NAME = os.environ['DB_NAME']
        DB_USER = os.environ['DB_USER']
        DB_PASSWORD = os.environ['DB_PASSWORD']
        DB_PORT = int(os.environ.get('DB_PORT', 5432))

        SENDER_EMAIL = os.environ['SENDER_EMAIL'].strip() 
        RECEIVER_EMAIL = os.environ['RECEIVER_EMAIL'].strip()
        SES_REGION = os.environ['SES_REGION']

        # ---------- Connect to PostgreSQL ----------
        conn = pg8000.connect(
            host=DB_HOST,
            user=DB_USER,
            password=DB_PASSWORD,
            database=DB_NAME,
            port=DB_PORT,
            ssl_context=True
        )

        cursor = conn.cursor()

        query = """
            SELECT 
                p.PTY_FirstName,
                p.PTY_LastName,
                p.PTY_Phone,
                a.Add_City,
                s.Stt_Name
            FROM OPT_Party p
            JOIN OPT_Address a ON p.PTY_ID = a.Add_PartyID
            JOIN SYS_State s ON a.Add_State = s.Stt_ID
            ORDER BY p.PTY_FirstName;
        """

        cursor.execute(query)
        rows = cursor.fetchall()

        cursor.close()
        conn.close()

        print(f"Fetched {len(rows)} records from database")

        # ---------- Create CSV in Memory ----------
        csv_buffer = io.StringIO()
        writer = csv.writer(csv_buffer)

        writer.writerow([
            "First Name",
            "Last Name",
            "Phone",
            "City",
            "State"
        ])

        writer.writerows(rows)

        csv_content = csv_buffer.getvalue()
        csv_buffer.close()

        # ---------- Build Email with Attachment ----------
        msg = MIMEMultipart()
        msg['Subject'] = "Client Report â€“ Generated by AWS Lambda"
        msg['From'] = SENDER_EMAIL
        msg['To'] = RECEIVER_EMAIL

        body = MIMEText(
            "Hello ,\n\n"
            "Please find attached the client report generated automatically "
            "by AWS Lambda.\n\n"
            "Regards,\n"
            "AWS Cloud Automation System",
            "plain"
        )

        msg.attach(body)

        attachment = MIMEApplication(csv_content)
        attachment.add_header(
            'Content-Disposition',
            'attachment',
            filename='client_report.csv'
        )

        msg.attach(attachment)

        # ---------- Send Email via SES ----------
        ses = boto3.client('ses', region_name=SES_REGION)

        ses.send_raw_email(
            Source=SENDER_EMAIL,
            Destinations=[RECEIVER_EMAIL],
            RawMessage={'Data': msg.as_string()}
        )

        print("Email sent successfully")

        return {
            "statusCode": 200,
            "headers": {
                "Content-Type": "text/plain"
            },
            "body": "Request processed successfully. Email with CSV attachment sent."
        }

    except Exception as e:
        print("Error:", str(e))
        return {
            "statusCode": 500,
            "error": str(e)
        }
